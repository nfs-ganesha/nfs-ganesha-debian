From 2ec3d64977fbd813d8cb78fe648abf4fec605557 Mon Sep 17 00:00:00 2001
From: Gaurav Gangalwar <gaurav.gangalwar@nutanix.com>
Date: Tue, 15 Mar 2022 11:28:40 +0000
Subject: [PATCH] Fix release dupreq_entry_t before access.

Signed-off-by: Gaurav Gangalwar <gaurav.gangalwar@gmail.com>
Change-Id: I36099afeef99e91a03e2badd8676df4afd4e66b0
---
 src/RPCAL/nfs_dupreq.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/RPCAL/nfs_dupreq.c b/src/RPCAL/nfs_dupreq.c
index 0f4137df7..832949d53 100644
--- a/src/RPCAL/nfs_dupreq.c
+++ b/src/RPCAL/nfs_dupreq.c
@@ -1425,10 +1425,6 @@ void nfs_dupreq_rele(nfs_request_t *reqnfs)
 		     dv, dv->hin.tcp.rq_xid, drc,
 		     dupreq_state_table[dv->complete], dv->refcnt);
 
-	/* release req's hold on dupreq and drc */
-	dupreq_entry_put(dv);
-	nfs_dupreq_put_drc(drc);
-
 	/* Now check if there are any duplicate requests waiting for this
 	 * one to resolve.
 	 */
@@ -1457,6 +1453,10 @@ void nfs_dupreq_rele(nfs_request_t *reqnfs)
 
 	PTHREAD_MUTEX_unlock(&dv->mtx);
 
+	/* release req's hold on dupreq and drc */
+	dupreq_entry_put(dv);
+	nfs_dupreq_put_drc(drc);
+
  out:
 	/* dispose RPC header */
 	if (reqnfs->svc.rq_auth)
-- 
2.36.1

